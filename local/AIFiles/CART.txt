import pandas as pd
import os
import moxing as mox

!wget https://labfiles-singapore.obs.ap-southeast-3.myhuaweicloud.com/modelarts/Titanictrain.csv
data = pd.read_csv('Titanictrain.csv', sep=',')
data.head()

data.info()

# Calculate the total number of missing features.
total = data.isnull().sum().sort_values(ascending=False)
# Calculate the missing ratio of each feature.
percent = (data.isnull().sum() / data.isnull().count()).sort_values(ascending=False)
miss_data = pd.concat([total, percent], axis=1, keys=['Miss_Total', 'Miss_Percent'])
miss_data.head()

# Handle the missing values.
# Delete Cabin.
del data['Cabin']
# Use the median to fill the missing value.
data['Age'] = data['Age'].fillna(data['Age'].median())
# Fill in the missing values.
data['Embarked'] = data['Embarked'].fillna(data['Embarked'].mode()[0])
# View the data.
data.info()

from sklearn.preprocessing import LabelEncoder

# Check the name features and extract the title.
data['Title'] = data['Name'].str.split(",", expand=True)[1].str.split(".", expand=True)[0]
# Perform numeric processing for character variables.
label = LabelEncoder()
data['Sex_Code'] = label.fit_transform(data['Sex'])
data['Title_Code'] = label.fit_transform(data['Title'])
data['Embarked'] = data['Embarked'].astype(str)
data['Embarked_Code'] = label.fit_transform(data['Embarked'])
# PassengerId and Ticker are randomly generated variables that do not affect the target variable. Therefore, remove them during feature selection.
features = ['Pclass', 'Age', 'SibSp', 'Parch', 'Fare', 'Sex_Code', 'Title_Code', 'Embarked_Code', 'Survived']
data = data[features]
data.head()

from sklearn.model_selection import train_test_split

X = data[['Pclass', 'Age', 'SibSp', 'Parch', 'Fare', 'Sex_Code', 'Title_Code', 'Embarked_Code']]
y = data[['Survived']]
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2,
                                                    random_state=2) # random_state is a random seed. Ensure that the division results are the same.

from sklearn.tree import DecisionTreeClassifier

dtc = DecisionTreeClassifier()
dtc.fit(X_train, y_train)
y_predict = dtc.predict(X_test)

from sklearn.metrics import accuracy_score
from sklearn.metrics import f1_score
from sklearn.metrics import recall_score
from sklearn.metrics import precision_score

# Model scoring: accuracy, recall rate, precision rate, and F1 score
accuracy_score = accuracy_score(y_test, y_predict)
recall_score = recall_score(y_test, y_predict)
precision_score = precision_score(y_test, y_predict)
f1_score = f1_score(y_test, y_predict)
print("DecisionTreeClassifier Results")
print("Accuracy      :", accuracy_score)
print("Recall        :", recall_score)
print("Precision     :", precision_score)
print("F1 Score      :", f1_score)

from sklearn.model_selection import GridSearchCV
from sklearn.metrics import make_scorer

param = {'max_depth': [1, 3, 5, 7]}
# Use grid search for parameter tuning.
gsearch = GridSearchCV(estimator=dtc, param_grid=param, cv=5, scoring='f1')
gsearch.fit(X=X_train, y=y_train)
print("Optimal parameter: {}".format(gsearch.best_params_))
print ("Optimal model: {}".format ((gsearch.best_estimator_)))
print ("Highest score of the model: {:.3f}".format (gsearch.score (X_test, y_test)))

from sklearn.tree import DecisionTreeClassifier
import numpy as np

# Select the optimal model for prediction.
dtc = DecisionTreeClassifier(class_weight=None, criterion='gini', max_depth=3,
                             max_features=None, max_leaf_nodes=None,
                             min_samples_leaf=1, min_samples_split=2,
                             min_weight_fraction_leaf=0.0, presort=False, random_state=None,
                             splitter='best')
dtc.fit(X_train, y_train)
y_predict = dtc.predict(X_test)
# Print the prediction result.
print('===================Predicted value=======================')
print(y_predict)
# Print the actual value.
print('===================Actual value=======================')
print(np.array(y_test).tolist())

